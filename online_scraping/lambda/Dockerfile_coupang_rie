FROM mcr.microsoft.com/playwright:v1.52.0-jammy

WORKDIR /app

RUN apt-get update && apt-get install -y \
    g++ \
    make \
    cmake \
    unzip \
    libcurl4-openssl-dev \
    autoconf \
    libtool \
    ca-certificates \
    curl \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# --- Install Google Chrome Stable ---
RUN install -m 0755 -d /etc/apt/keyrings && \
curl -fsSL https://dl.google.com/linux/linux_signing_key.pub \
  | gpg --dearmor -o /etc/apt/keyrings/google-linux-signing-key.gpg && \
echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/google-linux-signing-key.gpg] http://dl.google.com/linux/chrome/deb/ stable main" \
  > /etc/apt/sources.list.d/google-chrome.list && \
apt-get update && apt-get install -y google-chrome-stable && \
rm -rf /var/lib/apt/lists/*

ENV NPM_CONFIG_CACHE=/tmp/.npm
ENV PLAYWRIGHT_BROWSERS_PATH=0

# Install Lambda Runtime Interfac{"statusCode":500,"body":{"message":"getaddrinfo ENOTFOUND host.docker.internal"}}e Emulator (RIE) for local testing
RUN mkdir -p /opt
RUN curl -Lo /opt/aws-lambda-rie https://github.com/aws/aws-lambda-runtime-interface-emulator/releases/latest/download/aws-lambda-rie && \
    chmod +x /opt/aws-lambda-rie

RUN npm install aws-lambda-ric -g

ENV IS_DOCKER=true
# Default DB_HOST for connecting to host MySQL (can be overridden with -e DB_HOST=...)
# On Linux, use 172.17.0.1 (Docker bridge gateway) or run with --add-host=host.docker.internal:host-gateway
# On Mac/Windows, host.docker.internal should work, but can override if needed
ENV DB_HOST=172.17.0.1
ENV DB_PORT=3307
ENV DATABASE=bznav_care_zent

COPY *.json ./
COPY *.ts ./
COPY db/*.ts ./db/
COPY gmail/*.ts ./gmail/
COPY gmail/*.json ./gmail/
COPY model/*.ts ./model/
COPY websocket/*.ts ./websocket/

RUN npm ci
RUN npm run build

RUN npx playwright install --with-deps
#RUN npx playwright install chromium

RUN cp *.json dist/

EXPOSE 9000 3306 6379 80 8080

ENTRYPOINT ["/opt/aws-lambda-rie"]
CMD ["/bin/npx", "aws-lambda-ric", "dist/main_coupang.handler"]

